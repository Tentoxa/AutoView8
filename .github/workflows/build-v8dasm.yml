name: Build V8 Disassembler (v8dasm)

on:
  push:
    branches: [ main ]
    paths:
      - 'Disassembler/**'
      - 'scripts/v8dasm-builders/**'
      - 'configs/v8-versions.json'
      - '.github/workflows/build-v8dasm.yml'
  pull_request:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      v8_version:
        description: 'V8 version to build (leave empty to build all)'
        required: false
        default: ''

jobs:
  prepare:
    name: Prepare Build Matrix
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
    steps:
      - uses: actions/checkout@v4

      - name: Set up build matrix
        id: set-matrix
        run: |
          if [ -n "${{ github.event.inputs.v8_version }}" ]; then
            echo "matrix={\"version\":[{\"v8\":\"${{ github.event.inputs.v8_version }}\",\"args\":\"v8_enable_pointer_compression=false\"}]}" >> $GITHUB_OUTPUT
          else
            echo "matrix={\"version\":[{\"v8\":\"12.6.228.21\",\"args\":\"v8_enable_pointer_compression=false\"}]}" >> $GITHUB_OUTPUT
          fi

  build-macos-arm:
    name: macOS ARM64 - V8 ${{ matrix.version.v8 }}
    if: false  # Temporarily disabled
    runs-on: macos-14
    needs: prepare
    strategy:
      matrix: ${{fromJson(needs.prepare.outputs.matrix)}}
      fail-fast: false
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python 3.12
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install Python dependencies
        run: pip3 install setuptools

      - name: Cache Depot Tools
        uses: actions/cache@v4
        with:
          path: ~/depot_tools
          key: depot-tools-macos-arm-${{ runner.os }}

      - name: Cache V8 Source
        uses: actions/cache@v4
        with:
          path: ~/v8
          key: v8-source-${{ matrix.version.v8 }}-macos-arm
          restore-keys: |
            v8-source-${{ matrix.version.v8 }}-macos-

      - name: Build v8dasm
        run: |
          chmod +x scripts/v8dasm-builders/build-macos-arm.sh
          scripts/v8dasm-builders/build-macos-arm.sh ${{ matrix.version.v8 }} "${{ matrix.version.args }}"

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: v8dasm-macos-arm64-v${{ matrix.version.v8 }}
          path: ${{ env.HOME }}/v8/v8/v8dasm-${{ matrix.version.v8 }}
          retention-days: 30

  build-windows:
    name: Windows x64 - V8 ${{ matrix.version.v8 }}
    runs-on: windows-2022
    needs: prepare
    env:
      V8_HOME: C:\Users\runneradmin
    strategy:
      matrix: ${{fromJson(needs.prepare.outputs.matrix)}}
      fail-fast: false
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python 3.12
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Cache Depot Tools
        uses: actions/cache@v4
        with:
          path: C:\Users\runneradmin\depot_tools
          key: depot-tools-windows-v1

      - name: Restore V8 Source Cache
        id: cache-v8
        uses: actions/cache/restore@v4
        with:
          path: C:\Users\runneradmin\v8
          key: v8-source-${{ matrix.version.v8 }}-windows

      - name: Fetch V8 source
        if: steps.cache-v8.outputs.cache-hit != 'true'
        id: fetch-v8
        shell: cmd
        run: call scripts\v8dasm-builders\setup-v8-windows.cmd ${{ matrix.version.v8 }}

      - name: Save V8 Source Cache
        if: steps.cache-v8.outputs.cache-hit != 'true' && steps.fetch-v8.outcome == 'success'
        uses: actions/cache/save@v4
        with:
          path: C:\Users\runneradmin\v8
          key: v8-source-${{ matrix.version.v8 }}-windows

      - name: Pre-build diagnostics
        if: always()
        shell: cmd
        run: |
          echo === Git version ===
          git --version
          echo.
          echo === V8 repo local git config ===
          git -C C:\Users\runneradmin\v8\v8 config --list --local
          echo.
          echo === core.hooksPath (if set) ===
          git -C C:\Users\runneradmin\v8\v8 config --get core.hooksPath
          if %errorlevel% neq 0 echo (not set)
          echo.
          echo === Global git config (hook-related) ===
          git config --global --list
          echo.
          echo === .git\hooks directory listing ===
          dir C:\Users\runneradmin\v8\v8\.git\hooks 2>&1
          if %errorlevel% neq 0 echo (directory not found)
          echo.
          echo === post-checkout hook content (if exists) ===
          if exist C:\Users\runneradmin\v8\v8\.git\hooks\post-checkout (
            type C:\Users\runneradmin\v8\v8\.git\hooks\post-checkout
          ) else (
            echo [no post-checkout hook found]
          )
          echo.
          echo === Testing hook disable: renaming .git\hooks ===
          if exist C:\Users\runneradmin\v8\v8\.git\hooks (
            ren C:\Users\runneradmin\v8\v8\.git\hooks hooks.diag-test
            echo Renamed .git\hooks to hooks.diag-test
          ) else (
            echo .git\hooks does not exist, nothing to rename
          )
          echo.
          echo === Running git status after hook rename ===
          git -C C:\Users\runneradmin\v8\v8 status
          echo git status survived, errorlevel=%errorlevel%
          echo.
          echo === Testing git checkout HEAD after hook rename ===
          git -C C:\Users\runneradmin\v8\v8 checkout HEAD
          echo git checkout HEAD survived, errorlevel=%errorlevel%
          echo.
          echo === Restoring hooks ===
          if exist C:\Users\runneradmin\v8\v8\.git\hooks.diag-test (
            ren C:\Users\runneradmin\v8\v8\.git\hooks.diag-test hooks
            echo Restored .git\hooks
          ) else (
            echo hooks.diag-test not found, nothing to restore
          )
          echo.
          echo === Checking for hooks in subdirectories ===
          if exist C:\Users\runneradmin\v8\v8\build\.git\hooks\post-checkout echo FOUND: build\post-checkout
          if exist C:\Users\runneradmin\v8\v8\third_party\.git\hooks\post-checkout echo FOUND: third_party\post-checkout
          if exist C:\Users\runneradmin\v8\v8\tools\.git\hooks\post-checkout echo FOUND: tools\post-checkout
          echo.
          echo === Diagnostics complete ===

      - name: Build v8dasm
        id: build
        shell: cmd
        run: call scripts\v8dasm-builders\build-windows.cmd ${{ matrix.version.v8 }} "${{ matrix.version.args }}"

      - name: Diagnostics
        if: always()
        shell: powershell
        run: |
          echo "=== Build step outcome: ${{ steps.build.outcome }} ==="
          echo "=== Listing C:\Users\runneradmin\v8\v8\ (top level) ==="
          if (Test-Path "C:\Users\runneradmin\v8\v8") {
            Get-ChildItem "C:\Users\runneradmin\v8\v8" -Filter "*.exe" | Select-Object Name, Length
            Get-ChildItem "C:\Users\runneradmin\v8\v8" -Filter "v8dasm*" | Select-Object Name, Length
          } else {
            echo "Directory C:\Users\runneradmin\v8\v8 does not exist"
          }
          echo "=== Listing C:\Users\runneradmin\v8\v8\out.gn (if exists) ==="
          if (Test-Path "C:\Users\runneradmin\v8\v8\out.gn") {
            Get-ChildItem "C:\Users\runneradmin\v8\v8\out.gn" -Recurse -Filter "*.exe" | Select-Object FullName, Length
          } else {
            echo "out.gn does not exist - build never ran gn gen"
          }

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: v8dasm-windows-x64-v${{ matrix.version.v8 }}
          path: C:/Users/runneradmin/v8/v8/v8dasm-${{ matrix.version.v8 }}.exe
          retention-days: 30

  release:
    name: Create Release
    runs-on: ubuntu-latest
    needs: [build-windows]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    steps:
      - uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Prepare release assets
        run: |
          mkdir -p release
          cd artifacts

          for dir in v8dasm-*; do
            platform=$(echo $dir | sed 's/v8dasm-//' | sed 's/-v[0-9].*//')
            version=$(echo $dir | grep -oP 'v\K[0-9]+\.[0-9]+\.[0-9]+\.[0-9]+')

            cd $dir
            # Find versioned artifact files
            if [ -f v8dasm-${version}.exe ]; then
              zip ../../release/${platform}-${version}.zip v8dasm-${version}.exe
            elif [ -f v8dasm-${version} ]; then
              zip ../../release/${platform}-${version}.zip v8dasm-${version}
            fi
            cd ..
          done

      - name: Generate release notes
        run: |
          cat > release_notes.md << 'EOF'
          ## V8 Disassembler Binaries

          This release contains pre-built v8dasm binaries for multiple platforms and V8 versions.

          ### Supported V8 versions:
          - **12.6.228.21**

          ### Supported platforms:
          - Windows x64

          ### Usage:
          Download the binary for your platform and V8 version, then use it with View8:
          ```bash
          python view8.py input.jsc output.js --path ./v8dasm
          ```

          ### Build info:
          - Built from commit: ${{ github.sha }}
          - Build time: $(date -u +"%Y-%m-%d %H:%M:%S UTC")
          EOF

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v8dasm-${{ github.run_number }}
          name: V8 Disassembler Build ${{ github.run_number }}
          body_path: release_notes.md
          draft: false
          prerelease: false
          files: release/*.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

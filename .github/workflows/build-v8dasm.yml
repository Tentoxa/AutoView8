name: Build V8 Disassembler (v8dasm)

on:
  push:
    branches: [ main ]
    paths:
      - 'Disassembler/**'
      - 'scripts/v8dasm-builders/**'
      - 'configs/v8-versions.json'
      - '.github/workflows/build-v8dasm.yml'
  pull_request:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      v8_version:
        description: 'V8 version to build (leave empty to build all)'
        required: false
        default: ''

jobs:
  prepare:
    name: Prepare Build Matrix
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
    steps:
      - uses: actions/checkout@v4

      - name: Set up build matrix
        id: set-matrix
        run: |
          if [ -n "${{ github.event.inputs.v8_version }}" ]; then
            echo "matrix={\"version\":[{\"v8\":\"${{ github.event.inputs.v8_version }}\",\"args\":\"v8_enable_pointer_compression=false\"}]}" >> $GITHUB_OUTPUT
          else
            echo "matrix={\"version\":[{\"v8\":\"12.6.228.21\",\"args\":\"v8_enable_pointer_compression=false\"}]}" >> $GITHUB_OUTPUT
          fi

  build-macos-arm:
    name: macOS ARM64 - V8 ${{ matrix.version.v8 }}
    if: false  # Temporarily disabled
    runs-on: macos-14
    needs: prepare
    strategy:
      matrix: ${{fromJson(needs.prepare.outputs.matrix)}}
      fail-fast: false
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python 3.12
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install Python dependencies
        run: pip3 install setuptools

      - name: Cache Depot Tools
        uses: actions/cache@v4
        with:
          path: ~/depot_tools
          key: depot-tools-macos-arm-${{ runner.os }}

      - name: Cache V8 Source
        uses: actions/cache@v4
        with:
          path: ~/v8
          key: v8-source-${{ matrix.version.v8 }}-macos-arm
          restore-keys: |
            v8-source-${{ matrix.version.v8 }}-macos-

      - name: Build v8dasm
        run: |
          chmod +x scripts/v8dasm-builders/build-macos-arm.sh
          scripts/v8dasm-builders/build-macos-arm.sh ${{ matrix.version.v8 }} "${{ matrix.version.args }}"

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: v8dasm-macos-arm64-v${{ matrix.version.v8 }}
          path: ${{ env.HOME }}/v8/v8/v8dasm-${{ matrix.version.v8 }}
          retention-days: 30

  build-windows:
    name: Windows x64 - V8 ${{ matrix.version.v8 }}
    runs-on: windows-2022
    needs: prepare
    strategy:
      matrix: ${{fromJson(needs.prepare.outputs.matrix)}}
      fail-fast: false
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python 3.12
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Cache Depot Tools
        uses: actions/cache@v4
        with:
          path: ~/depot_tools
          key: depot-tools-windows-${{ runner.os }}

      - name: Cache V8 Source
        uses: actions/cache@v4
        with:
          path: ~/v8
          key: v8-source-${{ matrix.version.v8 }}-windows
          restore-keys: |
            v8-source-${{ matrix.version.v8 }}-

      - name: Build v8dasm
        shell: cmd
        run: |
          call scripts\v8dasm-builders\build-windows.cmd ${{ matrix.version.v8 }} "${{ matrix.version.args }}"

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: v8dasm-windows-x64-v${{ matrix.version.v8 }}
          path: ${{ env.USERPROFILE }}\v8\v8\v8dasm-${{ matrix.version.v8 }}.exe
          retention-days: 30

  release:
    name: Create Release
    runs-on: ubuntu-latest
    needs: [build-windows]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    steps:
      - uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Prepare release assets
        run: |
          mkdir -p release
          cd artifacts

          for dir in v8dasm-*; do
            platform=$(echo $dir | sed 's/v8dasm-//' | sed 's/-v[0-9].*//')
            version=$(echo $dir | grep -oP 'v\K[0-9]+\.[0-9]+\.[0-9]+\.[0-9]+')

            cd $dir
            # Find versioned artifact files
            if [ -f v8dasm-${version}.exe ]; then
              zip ../../release/${platform}-${version}.zip v8dasm-${version}.exe
            elif [ -f v8dasm-${version} ]; then
              zip ../../release/${platform}-${version}.zip v8dasm-${version}
            fi
            cd ..
          done

      - name: Generate release notes
        run: |
          cat > release_notes.md << 'EOF'
          ## V8 Disassembler Binaries

          This release contains pre-built v8dasm binaries for multiple platforms and V8 versions.

          ### Supported V8 versions:
          - **12.6.228.21**

          ### Supported platforms:
          - Windows x64

          ### Usage:
          Download the binary for your platform and V8 version, then use it with View8:
          ```bash
          python view8.py input.jsc output.js --path ./v8dasm
          ```

          ### Build info:
          - Built from commit: ${{ github.sha }}
          - Build time: $(date -u +"%Y-%m-%d %H:%M:%S UTC")
          EOF

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v8dasm-${{ github.run_number }}
          name: V8 Disassembler Build ${{ github.run_number }}
          body_path: release_notes.md
          draft: false
          prerelease: false
          files: release/*.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
